apiVersion: traefik.containo.us/v1alpha1
kind: IngressRoute
metadata:
  name: iglog
spec:
  entryPoints:
    - websecure
  routes:
    - match: Host(`api.seankhliao.com`) && PathPrefix(`/iglog`)
      kind: Rule
      services:
        - name: iglog
          port: 80
  tls:
    secretName: acme-prod-crt-secret
---
apiVersion: v1
kind: Service
metadata:
  name: iglog
spec:
  type: ClusterIP
  ports:
    - name: web
      port: 80
      targetPort: web
  selector:
    app: iglog
---
kind: Deployment
apiVersion: apps/v1
metadata:
  name: iglog
  labels:
    app: iglog
spec:
  replicas: 1
  selector:
    matchLabels:
      app: iglog
  template:
    metadata:
      labels:
        app: iglog
    spec:
      nodeSelector:
        cloud.google.com/gke-preemptible: "true"
      containers:
        - name: iglog
          image: gcr.io/com-seankhliao/iglog:latest
          resources:
            requests:
              cpu: 20m
          env:
            - name: GOOGLE_APPLICATION_CREDENTIALS
              value: /var/secrets/google/key.json
            - name: PORT
              value: ":8080"
            - name: GODEBUG
              value: tls13=1
            - name: LOG_LEVEL
              value: INFO
            - name: BUCKET
              value: iglog-storage
            - name: ORIGINS
              value: "https://seankhliao.com, https://com-seankhliao.web.app, https://com-seankhliao.firebaseapp.com"
            - name: HEADERS
              value: "*"
            - name: EMAILS
              value: seankhliao@gmail.com
            # - name: IG_USER
            #   valueFrom:
            #     secretKeyRef:
            #       name: insta-user
            #       key: user
            # - name: IG_PASS
            #   valueFrom:
            #     secretKeyRef:
            #       name: insta-user
            #       key: pass
          livenessProbe:
            initialDelaySeconds: 2
            periodSeconds: 2
            httpGet:
              path: /health
              port: web
          readinessProbe:
            initialDelaySeconds: 2
            periodSeconds: 2
            httpGet:
              path: /ready
              port: web
          ports:
            - name: web
              containerPort: 8080
          volumeMounts:
            - name: service-account-key
              mountPath: /var/secrets/google
      volumes:
        - name: service-account-key
          secret:
            secretName: firebase-admin
