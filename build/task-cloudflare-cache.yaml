apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: cloudflare-cache-purge
spec:
  volumes:
    - name: cloudflare-secret
      secret:
        secretName: $(params.secret)
  params:
    - name: secret
      description: name of k8s secret
      default: cloudflare-cache-token
    - name: urls
      description: stringified json array of urls to purge
      default: '["https://seankhliao.com/newtab/", "https://seankhliao.com/blog/"]'
  steps:
    - name: purge
      image: curlimages/curl
      volumeMounts:
        - name: cloudflare-secret
          mountPath: /var/secrets
      script: |
        #!/bin/sh
        curl -X POST "https://api.cloudflare.com/client/v4/zones/$(cat /var/secrets/zone)/purge_cache" \
          -H "Authorization: Bearer $(cat /var/secrets/token)" \
          -H "Content-Type:application/json" \
          -d '{"files":$(params.urls)}'
