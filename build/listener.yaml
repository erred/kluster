apiVersion: traefik.containo.us/v1alpha1
kind: IngressRoute
metadata:
  name: simple-el
spec:
  entryPoints:
    - https
  routes:
    - kind: Rule
      match: Host(`build.seankhliao.com`)
      services:
        - kind: Service
          name: el-simple-el
          namespace: build
          port: 8080
  tls: {}
---
apiVersion: triggers.tekton.dev/v1alpha1
kind: EventListener
metadata:
  name: simple-el
spec:
  serviceAccountName: tekton-triggers-admin
  triggers:
    - name: calproxy
      interceptors:
        - github:
            secretRef:
              secretName: github-webhook-token
              secretKey: shared
            eventTypes:
        - cel:
            filter: "header.match('X-GitHub-Event', 'push') && (split(body.ref, '/')[1] == 'tags') && (body.repository.name == 'calproxy')"
            overlays:
              - key: extensions.tag_name
                expression: "split(body.ref, '/')[2]"
      bindings:
        - name: simple-container
      template:
        name: calproxy
    - name: http-server
      interceptors:
        - github:
            secretRef:
              secretName: github-webhook-token
              secretKey: shared
            eventTypes:
        - cel:
            filter: "header.match('X-GitHub-Event', 'push') && (split(body.ref, '/')[1] == 'tags') && (body.repository.name == 'http-server')"
            overlays:
              - key: extensions.tag_name
                expression: "split(body.ref, '/')[2]"
      bindings:
        - name: simple-container
      template:
        name: http-server
    - name: statslogger
      interceptors:
        - github:
            secretRef:
              secretName: github-webhook-token
              secretKey: shared
            eventTypes:
        - cel:
            filter: "header.match('X-GitHub-Event', 'push') && (split(body.ref, '/')[1] == 'tags') && (body.repository.name == 'statslogger')"
            overlays:
              - key: extensions.tag_name
                expression: "split(body.ref, '/')[2]"
      bindings:
        - name: simple-container
      template:
        name: statslogger
    - name: vanity
      interceptors:
        - github:
            secretRef:
              secretName: github-webhook-token
              secretKey: shared
            eventTypes:
        - cel:
            filter: "header.match('X-GitHub-Event', 'push') && (split(body.ref, '/')[1] == 'tags') && (body.repository.name == 'vanity')"
            overlays:
              - key: extensions.tag_name
                expression: "split(body.ref, '/')[2]"
      bindings:
        - name: simple-container
      template:
        name: vanity
    - name: webstyle
      interceptors:
        - github:
            secretRef:
              secretName: github-webhook-token
              secretKey: shared
            eventTypes:
        - cel:
            filter: "header.match('X-GitHub-Event', 'push') && (split(body.ref, '/')[1] == 'tags') && (body.repository.name == 'webstyle')"
            overlays:
              - key: extensions.tag_name
                expression: "split(body.ref, '/')[2]"
      bindings:
        - name: simple-container
      template:
        name: webstyle
    - name: wggo
      interceptors:
        - github:
            secretRef:
              secretName: github-webhook-token
              secretKey: shared
            eventTypes:
        - cel:
            filter: "header.match('X-GitHub-Event', 'push') && (split(body.ref, '/')[1] == 'tags') && (body.repository.name == 'wggo')"
            overlays:
              - key: extensions.tag_name
                expression: "split(body.ref, '/')[2]"
      bindings:
        - name: simple-container
      template:
        name: wggo
