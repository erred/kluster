apiVersion: traefik.containo.us/v1alpha1
kind: IngressRoute
metadata:
  name: simple-el
spec:
  entryPoints:
    - https
  routes:
    - kind: Rule
      match: Host(`build.seankhliao.com`)
      services:
        - kind: Service
          name: el-simple-el
          namespace: build
          port: 8080
  tls: {}
---
apiVersion: triggers.tekton.dev/v1alpha1
kind: EventListener
metadata:
  name: simple-el
spec:
  serviceAccountName: tekton-triggers-admin
  triggers:
    # - name: ci
    #   interceptors:
    #     - github:
    #         secretRef:
    #           secretName: github-webhook-token
    #           secretKey: shared
    #         eventTypes:
    #     - cel:
    #         filter: "header.match('X-GitHub-Event', 'push') && (body.repository.name.startsWith('ci-'))"
    #         overlays:
    #           - key: extensions.tag_name
    #             expression: "body.head_commit.id"
    #           - key: extensions.mangledtag
    #             expression: "truncate(body.head_commit.id, 7)"
    #   bindings:
    #     - name: simple-container
    #   template:
    #     name: ci
    - name: simple-container
      interceptors:
        - github:
            secretRef:
              secretName: github-webhook-token
              secretKey: shared
            eventTypes:
        - cel:
            filter: "header.match('X-GitHub-Event', 'push') && (split(body.ref, '/')[1] == 'tags') && (body.repository.name in ['calproxy', 'http-server', 'rebuilderd', 'statslogger', 'vanity', 'webstyle', 'wggo'])"
            overlays:
              - key: extensions.tag_name
                expression: "split(body.ref, '/')[2]"
              - key: extensions.mangledtag
                expression: "split(split(body.ref, '/')[2], '.')[0]+'-'+split(split(body.ref, '/')[2], '.')[1]+'-'+split(split(body.ref, '/')[2], '.')[2]"
      bindings:
        - name: simple-container
      template:
        name: simple-container
    - name: com-deploy
      interceptors:
        - github:
            secretRef:
              secretName: github-webhook-token
              secretKey: shared
            eventTypes:
        - cel:
            filter: "header.match('X-GitHub-Event', 'push') && (split(body.ref, '/')[1] == 'tags') && (body.repository.name == 'com-seankhliao')"
            overlays:
              - key: extensions.tag_name
                expression: "split(body.ref, '/')[2]"
              - key: extensions.mangledtag
                expression: "split(split(body.ref, '/')[2], '.')[0]+'-'+split(split(body.ref, '/')[2], '.')[1]+'-'+split(split(body.ref, '/')[2], '.')[2]"
      bindings:
        - name: simple-container
      template:
        name: com-deploy
