apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: github-webhook
spec:
  # https://developer.github.com/v3/repos/hooks/#create-a-hook
  volumes:
    - name: github-secret
      secret:
        secretName: $(params.secret)
  params:
    - name: secret
      description: name of k8s secret
      default: github-webhook-token
    - name: user
      description: name of user for api token
      default: seankhliao
    - name: key
      description: name of key for api token from $secret
      default: token
    - name: events
      description: events to subscribe to (stringified json array)
      default: '["push"]'
    - name: url
      description: callback url
      default: https://build.seankhliao.com
    - name: shared_secret
      description: shared secret with github
      default: asharedsecretwithgithub
    - name: owner
      description: repo owner
      default: seankhliao
    - name: repo
      description: repo name
  steps:
    - name: create-webhook
      image: curlimages/curl
      volumeMounts:
        - name: github-secret
          mountPath: /var/secret
      script: |
        #!/bin/sh

        curl -L -v \
          -H 'Content-Type: application/json' \
          -u $(params.user):$(cat /var/secret/$(params.key)) \
          -d '{"name":"web", "events":$(params.events), "config": {"url": "$(params.url)", "secret": "$(params.shared_secret)", "content_type":"json"}}' \
          https://api.github.com/repos/$(params.owner)/$(params.repo)/hooks
