apiVersion: triggers.tekton.dev/v1alpha1
kind: TriggerTemplate
metadata:
  name: simple-container
spec:
  params:
    - name: url
      description: The git repository url
    - name: revision
      description: The git revision
    - name: image
      description: container image name
    - name: mangledtag
      description: used in naming
      default: $(uid)
  resourcetemplates:
    - apiVersion: tekton.dev/v1beta1
      kind: PipelineRun
      metadata:
        name: z-$(params.image)-$(params.mangledtag)
      spec:
        serviceAccountName: build-bot
        pipelineSpec:
          workspaces:
            - name: src
          tasks:
            - name: clone
              taskRef:
                name: git-clone
              params:
                - name: url
                  value: $(params.url)
                - name: revision
                  value: $(params.revision)
              workspaces:
                - name: src
                  workspace: src
            - name: build
              taskRef:
                name: kaniko
              runAfter:
                - clone
              params:
                - name: image
                  value: seankhliao/$(params.image)
                - name: tag
                  value: $(params.revision)
              workspaces:
                - name: src
                  workspace: src
        workspaces:
          - name: src
            persistentVolumeClaim:
              claimName: simple-container
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: simple-container
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
