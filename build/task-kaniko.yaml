apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: kaniko
spec:
  params:
    - name: image
      description: Name (reference) of the image to build.
    - name: tag
      description: Tag to apply to image
      default: latest
    - name: dockerfile
      description: Path to the Dockerfile to build.
      default: ./Dockerfile
    - name: context
      description: The build context used by Kaniko.
      default: ./
  workspaces:
    - name: src
  steps:
    - name: build-and-push
      workingDir: $(workspaces.src.path)
      image: gcr.io/kaniko-project/executor:latest
      env:
        - name: DOCKER_CONFIG
          value: /tekton/home/.docker
      args:
        - --cache
        - --context=$(workspaces.src.path)/$(params.context)
        - --destination=$(params.image):$(params.tag)
        - --destination=$(params.image):latest
        - --dockerfile=$(params.dockerfile)
        - --reproducible
        # - --single-snapshot
      # securityContext:
      #   runAsUser: 0
