apiVersion: tekton.dev/v1alpha1
kind: Task
metadata:
  name: webhook-ingress
spec:
  volumes:
    - name: work
      emptyDir: {}
  inputs:
    params:
      - name: ExternalDomain
        description: "The external domain for the EventListener e.g. `$(inputs.params.EventListenerName).PROXYIP.nip.io`"
      - name: Service
        description: "The name of the Service used in the Ingress. This will also be the name of the Ingress."
  steps:
    - name: create-ingress
      image: bitnami/kubectl:latest
      command:
        - sh
      args:
        - -ce
        - |
          set -e
          cat <<EOF | kubectl create -f - || true

          apiVersion: traefik.containo.us/v1alpha1
          kind: IngressRoute
          metadata:
            name: $(inputs.params.Service)
          spec:
            entryPoints:
              - https
            tls: {}
            routes:
              - kind: Rule
                match: Host(\`$(inputs.params.ExternalDomain)\`)
                services:
                  - kind: Service
                    name: $(inputs.params.Service)
                    port: 80
          EOF
          fi
