apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app.kubernetes.io/name: weechat
  name: weechat
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: weechat
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
  template:
    metadata:
      labels:
        app.kubernetes.io/name: weechat
    spec:
      securityContext:
        fsGroup: 65534
        runAsGroup: 65534
        runAsNonRoot: true
        runAsUser: 65534
      serviceAccountName: weechat
      terminationGracePeriodSeconds: 10
      containers:
        - name: weechat
          image: jkaberg/weechat:latest
          command:
            - /usr/bin/weechat-headless
            - --dir=/weechat
          ports:
            - name: irc-tls
              containerPort: 6697
          volumeMounts:
            - name: weechat-logs
              mountPath: /weechat
            - name: weechat-ssl
              mountPath: /weechat/ssl
            - name: weechat-ssl
              mountPath: /weechat/relay.conf
              subPath: relay.conf # contains password
            - name: weechat-config
              mountPath: /weechat/irc.conf
              subPath: irc.conf
            - name: weechat-config
              mountPath: /weechat/logger.conf
              subPath: logger.conf
      volumes:
        - name: weechat-config
          configMap:
            name: weechat-config
        - name: weechat-ssl
          secret:
            secretName: weechat-ssl
        - name: weechat-logs
          persistentVolumeClaim:
            claimName: weechat-logs
