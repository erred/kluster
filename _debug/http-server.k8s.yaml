apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: http-server-internal
spec:
  secretName: http-server-internal
  duration: 2160h
  renewBefore: 360h
  dnsNames:
    - "http-server.seankhliao.com"
  ipAddresses:
    - "10.205.0.44"
    - "10.205.0.45"
    - "10.205.0.46"
    - "10.205.0.47"
    - "10.205.0.48"
    - "10.205.0.49"
    - "10.205.0.50"
    # - "http-server"
    # - "http-server.default"
    # - "http-server.default.svc"
    # - "http-server.default.svc.cluster.local"
  issuerRef:
    name: internal-ca
    kind: ClusterIssuer
---
apiVersion: traefik.containo.us/v1alpha1
kind: IngressRoute
metadata:
  name: http-server
spec:
  entryPoints:
    - https
  routes:
    - kind: Rule
      match: Host(`http-server.seankhliao.com`)
      services:
        - kind: Service
          name: http-server
          port: 443
          scheme: https
  tls: {}
---
apiVersion: v1
kind: Service
metadata:
  name: http-server
  labels:
    app: http-server
spec:
  type: ClusterIP
  ports:
    - port: 443
      targetPort: 443
  selector:
    app: http-server
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: http-server
spec:
  replicas: 1
  selector:
    matchLabels:
      app: http-server
      version: v1
  template:
    metadata:
      labels:
        app: http-server
        version: v1
    spec:
      containers:
        - name: http-server
          image: seankhliao/http-server-test:latest
          # image: us.gcr.io/com-seankhliao/http-server:latest
          # args:
          #   - -addr=:443
          #   - -tls-cert=/var/secret/tls/tls.crt
          #   - -tls-key=/var/secret/tls/tls.key
          imagePullPolicy: Always
          ports:
            - containerPort: 443
          volumeMounts:
            - mountPath: /var/secret/tls
              name: tlscerts
      volumes:
        - name: tlscerts
          secret:
            secretName: http-server-internal
