receivers:
  k8s_cluster:
    auth_type: serviceAccount
    node_conditions_to_report:
      - Ready
      - MemoryPressure
  otlp:
    protocols:
      grpc:
  prometheus:
    config:
      scrape_configs:
        - job_name: endpoints
          scrape_interval: 5s
          kubernetes_sd_configs:
            - role: endpoints
          relabel_configs:
            - source_labels:
                - __meta_kubernetes_service_annotation_prometheus_io_scrape
              regex: "true"
              action: keep
            - source_labels:
                - __meta_kubernetes_service_annotation_prometheus_io_scheme
              regex: (https?)
              action: replace
              target_label: __scheme__
            - source_labels:
                - __address__
                - __meta_kubernetes_service_annotation_prometheus_io_port
              regex: (.+):(\d+);(\d+)
              action: replace
              replacement: $$1:$$3
              target_label: __address__
            - source_labels:
                - __meta_kubernetes_service_annotation_prometheus_io_path
              regex: (.+)
              action: replace
              target_label: __metrics_path__
            - source_labels:
                - __meta_kubernetes_namespace
              action: replace
              target_label: namespace
            - source_labels:
                - __meta_kubernetes_pod_node_name
              action: replace
              target_label: node
            - action: labelmap
              regex: __meta_kubernetes_service_label_(.+)

processors:
  batch:
  memory_limiter:
    ballast_size_mib: 200
    check_interval: 5s
    limit_mib: 400
    spike_limit_mib: 50

exporters:
  jaeger:
    endpoint: http://jaeger.jaeger.svc.cluster.local:14250
    insecure: true
  prometheusremotewrite:
    endpoint: "http://prometheus.prometheus.svc.cluster.local/api/v1/write"

extensions:
  health_check:
    port: 13133
  pprof:
    endpoint: :1777
  zpages:
    endpoint: :55679

service:
  extensions:
    - health_check
    - pprof
    - zpages
  pipelines:
    metrics:
      receivers:
        - k8s_cluster
        - otlp
        - prometheus
      processors:
        - memory_limiter
        - batch
      exporters:
        - prometheusremotewrite

    traces:
      receivers:
        - otlp
      processors:
        - memory_limiter
        - batch
      exporters:
        - jaeger
