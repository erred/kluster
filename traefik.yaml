apiVersion: v1
kind: Service
metadata:
  name: traefik
spec:
  type: ClusterIP
  ports:
    - name: web
      port: 80
      targetPort: web
    - name: websecure
      port: 443
      targetPort: websecure
  selector:
    app: traefik
---
kind: Deployment
apiVersion: apps/v1
metadata:
  namespace: default
  name: traefik
  labels:
    app: traefik
spec:
  replicas: 1
  selector:
    matchLabels:
      app: traefik
  template:
    metadata:
      labels:
        app: traefik
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: cloud.google.com/gke-preemptible
                    operator: DoesNotExist
      serviceAccountName: traefik-ingress-controller
      initContainers:
        - image: gcr.io/com-seankhliao/cf-dns-update:latest
          name: cf-dns-update
          env:
            - name: RECORD
              value: seankhliao.com:noproxy:api:A:1
            - name: X_AUTH_EMAIL
              valueFrom:
                secretKeyRef:
                  name: cloudflare
                  key: cloudflare_email
            - name: X_AUTH_KEY
              valueFrom:
                secretKeyRef:
                  name: cloudflare
                  key: cloudflare_key
      containers:
        - name: traefik
          imagePullPolicy: Always
          image: traefik:v2.0
          resources:
            requests:
              cpu: 300m
          args:
            - --accesslog
            - --entrypoints=Name:web Address::8080
            - --entrypoints=Name:websecure Address::8443
            - --providers.kubernetescrd
          env:
            - name: GODEBUG
              value: tls13=1
          ports:
            - name: web
              containerPort: 8080
              hostPort: 80
            - name: websecure
              containerPort: 8443
              hostPort: 443
#           volumeMounts:
#             - name: config
#               mountPath: /etc/traefik/
#             - name: acme-prod-certs
#               mountPath: /var/secrets/acme/
#       volumes:
#         - name: config
#           configMap:
#             name: traefikconf
#         - name: acme-prod-certs
#           secret:
#             secretName: acme-prod-crt-secret
# ---
# apiVersion: v1
# kind: ConfigMap
# metadata:
#   name: traefikconf
# data:
#   traefik.toml: |
#     [tlsStores.default.defaultCertificate]
#       certFile = "/var/secrets/acme/tls.crt"
#       keyFile  = "/var/secrets/acme/tls.key"
